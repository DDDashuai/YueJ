import{u as oe}from"./chat-9yJ8IeLc.js";import{u as ne,r as i,m as le,y as re,C as S,c as v,d as a,b as o,F as b,A as L,z as G,w as u,e as ie,f as n,h as l,o as c,B as A,t as I,i as D,n as ue}from"./index-Ba33ohK4.js";import{a as ce}from"./date-mP0Ysl1n.js";import{A as de}from"./AvatarLetter-DdsVXMGW.js";import{_ as ve}from"./_plugin-vue_export-helper-DlAUqK2U.js";const pe={class:"chat-page"},fe={class:"message-list"},_e={key:0,class:"message-content user"},me={class:"avatar"},he={class:"message-content ai"},ye={key:0,class:"typing"},ge={key:1,class:"ai-response"},we={class:"input-area"},Ce={class:"type-select"},ke={class:"type-options"},be=["onClick"],Ie={class:"message-input-wrapper"},xe={class:"toolbar-left"},Ve={class:"history-container"},ze={class:"message-count"},Te=Object.assign({name:"Chat"},{__name:"Chat",setup(He){const h=ie(),d=ne(),r=oe(),y=i(null),p=i(""),x=i(!1),f=i(!1),g=i(!1),U=i(!1),w=i(!1),B=i([]),V=i([]),_=i("western"),F=[{text:"西医咨询",value:"western"},{text:"中医咨询",value:"traditional"}],z=i(!1),N=s=>{_.value=s,z.value=!1};le(()=>r.chatHistory.length,()=>{T()}),re(()=>{R()});const R=async()=>{var s;(s=d.user)!=null&&s.userId&&(await r.getChatGroups(d.user.userId),r.currentGroupId||await r.createChatGroup(),T())},T=async()=>{await S(),y.value&&(y.value.scrollTop=y.value.scrollHeight)},$=()=>{h.back()},j=async()=>{var s;if(p.value.trim()){if(!((s=d.user)!=null&&s.userId)){n("请先登录"),h.push("/login");return}x.value=!0;try{await r.sendMessage({userId:d.user.userId,message:p.value,type:"user",conversationType:_.value}),p.value=""}catch{n("发送失败")}finally{x.value=!1}}},E=s=>s.type.startsWith("image/")?s.size/1024/1024<2?!0:(n("图片大小不能超过2MB"),!1):(n("请上传图片文件"),!1),O=async s=>{var m;if(!((m=d.user)!=null&&m.userId)){n("请先登录"),h.push("/login");return}const e=new FormData;e.append("image",s.file),e.append("conversationType",_.value);try{await r.sendImage(e),V.value=[]}catch{n("图片分析失败")}},P=()=>{f.value=!0,H()},H=async()=>{var s;if(!g.value&&(s=d.user)!=null&&s.userId)try{const e=await r.getChatGroups(d.user.userId);B.value=e,U.value=!0}catch{n("加载历史记录失败")}finally{g.value=!1}},W=async s=>{try{if(f.value=!1,console.log("选择的聊天组:",s),!s.chat_group_id){n("无效的聊天记录");return}await r.loadGroupChat(d.user.userId,s.chat_group_id),await S(),T()}catch(e){console.error("加载聊天记录失败:",e),n("加载聊天记录失败")}},q=async()=>{w.value=!0;try{await H()}finally{w.value=!1}},J=async()=>{var s;try{if(!((s=d.user)!=null&&s.userId)){n("请先登录"),h.push("/login");return}await r.createChatGroup(),r.chatHistory=[],f.value=!1,p.value="",_.value="western",n("新建聊天成功")}catch(e){console.error("新建聊天失败:",e),n("新建聊天失败")}};return(s,e)=>{const m=l("van-nav-bar"),M=l("van-loading"),C=l("van-icon"),K=l("van-popover"),Q=l("van-uploader"),X=l("van-field"),Y=l("van-button"),Z=l("van-form"),ee=l("van-cell"),te=l("van-list"),se=l("van-pull-refresh"),ae=l("van-popup");return c(),v("div",pe,[a(m,{title:"智能问诊","left-arrow":"","right-text":"历史",onClickLeft:$,onClickRight:P,class:"chat-nav"}),o("div",{class:"chat-content",ref_key:"chatContainer",ref:y},[o("div",fe,[(c(!0),v(b,null,L(G(r).chatHistory,(t,k)=>(c(),v("div",{key:k,class:A(["message",t.type==="user"?"message-right":"message-left"])},[t.type==="user"?(c(),v("div",_e,I(t.message),1)):(c(),v(b,{key:1},[o("div",me,[a(de,{username:"AI",size:40})]),o("div",he,[t.loading?(c(),v("div",ye,[a(M,{type:"spinner",size:"20"}),e[7]||(e[7]=o("span",null,"AI正在思考...",-1))])):(c(),v("div",ge,I(t.response),1))])],64))],2))),128))])],512),o("div",we,[a(K,{show:z.value,"onUpdate:show":e[0]||(e[0]=t=>z.value=t),placement:"top-start",theme:"light",trigger:"click"},{reference:u(()=>[a(C,{name:_.value==="western"?"cluster-o":"flower-o",size:"20",class:"toolbar-icon"},null,8,["name"])]),default:u(()=>[o("div",Ce,[o("div",ke,[(c(),v(b,null,L(F,t=>o("div",{key:t.value,class:A(["type-option",{active:_.value===t.value}]),onClick:k=>N(t.value)},[a(C,{name:t.value==="western"?"cluster-o":"flower-o",class:"type-icon"},null,8,["name"]),D(" "+I(t.text),1)],10,be)),64))])])]),_:1},8,["show"]),a(Z,{onSubmit:j,class:"input-form"},{default:u(()=>[o("div",Ie,[o("div",xe,[a(Q,{modelValue:V.value,"onUpdate:modelValue":e[1]||(e[1]=t=>V.value=t),"max-count":1,"before-read":E,"after-read":O},{default:u(()=>[a(C,{name:"add-o",size:"20",class:"toolbar-icon"})]),_:1},8,["modelValue"])]),a(X,{modelValue:p.value,"onUpdate:modelValue":e[2]||(e[2]=t=>p.value=t),placeholder:"请描述您的症状或者健康问题...",autosize:{minHeight:24,maxHeight:72},type:"textarea",class:"message-field"},null,8,["modelValue"]),a(Y,{type:"primary",size:"small",loading:x.value,"native-type":"submit",class:"send-btn",round:""},{default:u(()=>e[8]||(e[8]=[D(" 发送 ")])),_:1},8,["loading"])])]),_:1})]),a(ae,{show:f.value,"onUpdate:show":e[6]||(e[6]=t=>f.value=t),position:"right",style:{width:"80%",height:"100%"},"z-index":"1000"},{default:u(()=>[o("div",Ve,[a(m,{title:"聊天历史","left-arrow":"",onClickLeft:e[3]||(e[3]=t=>f.value=!1)},{right:u(()=>[a(C,{name:"plus",size:"20",onClick:J})]),_:1}),a(se,{modelValue:w.value,"onUpdate:modelValue":e[5]||(e[5]=t=>w.value=t),onRefresh:q},{default:u(()=>[a(te,{loading:g.value,"onUpdate:loading":e[4]||(e[4]=t=>g.value=t),finished:U.value,"finished-text":"没有更多了",onLoad:H},{default:u(()=>[(c(!0),v(b,null,L(B.value,(t,k)=>(c(),ue(ee,{key:k,title:G(ce)(t.created_at),label:t.last_message,"is-link":"",onClick:Le=>W(t)},{value:u(()=>[o("span",ze,I(t.message_count)+"条消息",1)]),_:2},1032,["title","label","onClick"]))),128))]),_:1},8,["loading","finished"])]),_:1},8,["modelValue"])])]),_:1},8,["show"])])}}}),Ae=ve(Te,[["__scopeId","data-v-ebc0542b"]]);export{Ae as default};
