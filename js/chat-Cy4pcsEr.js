import{D as h,r as d,E as c}from"./index-Biv-8KlJ.js";const G=h("chat",()=>{const t=d([]),p=d([]),u=d(null),i=async()=>{try{const a=await c.post("/api/chat/group/create");return u.value=a.data,t.value=[],a.data}catch(a){throw console.error("创建聊天组失败:",a),a}};return{chatHistory:t,chatGroups:p,currentGroupId:u,createChatGroup:i,getChatGroups:async a=>{const r=await c.get(`/api/chat/groups/${a}`);return p.value=r,r},loadGroupChat:async(a,r)=>{try{u.value=r;const e=await c.get(`/api/chat/group/${a}/${r}`);console.log("加载的聊天记录:",e);const o=e.data||e;if(!Array.isArray(o))throw new Error("无效的聊天记录格式");const n=[];return o.forEach(s=>{s.message&&n.push({type:"user",message:s.message,createdAt:s.createdAt,chatGroupId:s.chatGroupId}),s.response&&n.push({type:"ai",response:s.response,createdAt:s.createdAt,chatGroupId:s.chatGroupId,loading:!1})}),n.sort((s,l)=>new Date(s.createdAt)-new Date(l.createdAt)),t.value=n,console.log("处理后的聊天记录:",n),n}catch(e){throw console.error("加载聊天记录失败:",e),e}},sendMessage:async a=>{u.value||(u.value=await i()),a.chatGroupId=u.value;try{if(!a.userId)throw new Error("用户未登录");t.value.push({type:"user",message:a.message,createdAt:new Date().toISOString(),chatGroupId:u.value});const r={type:"ai",loading:!0};t.value.push(r);const e=await c.post("/api/chat/text",a),o=t.value.indexOf(r);return o!==-1&&(t.value[o]={type:"ai",message:e.data.message,response:e.data.response,createdAt:e.data.createdAt,loading:!1,chatGroupId:u.value}),e}catch(r){throw t.value=t.value.filter(e=>e!==loadingMessage),r}},sendImage:async a=>{var r;try{const e=(r=userStore.user)==null?void 0:r.userId;if(!e)throw new Error("用户未登录");const o={type:"ai",loading:!0};t.value.push(o),a.append("userId",e);const n=await c.post("/api/chat/image",a,{headers:{"Content-Type":"multipart/form-data"}}),s=t.value.indexOf(o);return s!==-1&&(t.value[s]={...n,type:"ai",loading:!1}),n}catch(e){throw t.value=t.value.filter(o=>o!==loadingMessage),e}}}});export{G as u};
